name: Build and Release ROS2 Packages

on:
  workflow_dispatch:
    inputs:
      package:
        description: 'Package to build (from packages.yml)'
        required: true
        type: choice
        options:
          - all
          - teb
          - mppi
          - costmap-converter
      version:
        description: 'Version tag for release (e.g., 1.0.0)'
        required: true
        type: string

env:
  ROS_DISTRO: humble

permissions:
  contents: write

jobs:
  build-arm64:
    runs-on: ubuntu-24.04-arm

    container:
      image: arm64v8/ros:humble-perception
      options: --user root

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y \
            python3-colcon-common-extensions \
            python3-rosdep \
            python3-pip \
            dpkg-dev \
            fakeroot \
            git
          pip3 install pyyaml

      - name: Get package config
        id: pkg-config
        run: |
          python3 << 'EOF'
          import yaml
          import json
          import os

          with open('.github/packages.yml', 'r') as f:
              config = yaml.safe_load(f)

          selected = '${{ github.event.inputs.package }}'
          arm64_targets_config = config.get('arm64_targets', {})

          # Get list of packages to build
          if selected == 'all':
              package_names = list(config['packages'].keys())
          else:
              package_names = [selected]

          # Build package info list
          packages_info = []
          for pkg_name in package_names:
              pkg = config['packages'][pkg_name]
              pkg_targets = pkg.get('arm64_targets', ['generic'])

              targets = []
              for target_name in pkg_targets:
                  if target_name in arm64_targets_config:
                      target = arm64_targets_config[target_name]
                      targets.append({
                          'name': target_name,
                          'cpu_flags': target['cpu_flags'],
                          'suffix': target['suffix']
                      })

              packages_info.append({
                  'pkg_name': pkg_name,
                  'deb_name': pkg['deb_name'],
                  'description': pkg['description'].strip().split('\n')[0],
                  'repositories': pkg['repositories'],
                  'install_dirs': pkg['install_dirs'],
                  'dependencies': ', '.join(pkg['dependencies']),
                  'arm64_targets': targets
              })

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"packages={json.dumps(packages_info)}\n")

          print(f"Packages to build: {[p['pkg_name'] for p in packages_info]}")
          EOF

      - name: Initialize rosdep
        run: |
          rosdep init || true
          rosdep update

      - name: Clone repositories
        run: |
          mkdir -p /ros2_ws/src
          cd /ros2_ws/src

          python3 << 'EOF'
          import json
          import subprocess
          import os

          packages = json.loads('${{ steps.pkg-config.outputs.packages }}')
          cloned_repos = set()

          for pkg in packages:
              for repo in pkg['repositories']:
                  url = repo['url']
                  branch = repo['branch']
                  sparse = repo.get('sparse_checkout', None)
                  repo_name = url.rstrip('/').split('/')[-1].replace('.git', '')

                  # Skip if already cloned
                  repo_key = f"{url}:{branch}"
                  if repo_key in cloned_repos:
                      print(f"Skipping {repo_name} (already cloned)")
                      continue
                  cloned_repos.add(repo_key)

                  if sparse:
                      subprocess.run(['git', 'clone', '--filter=blob:none', '--sparse', '-b', branch, url, repo_name], check=True)
                      os.chdir(repo_name)
                      for path in sparse:
                          subprocess.run(['git', 'sparse-checkout', 'add', path], check=True)
                      os.chdir('..')
                  else:
                      subprocess.run(['git', 'clone', '-b', branch, url], check=True)
          EOF

      - name: Install package dependencies
        run: |
          cd /ros2_ws
          . /opt/ros/${ROS_DISTRO}/setup.sh
          rosdep install --from-paths src --ignore-src -r -y

      - name: Build and package for each ARM64 target
        run: |
          python3 << 'PYEOF'
          import json
          import subprocess
          import shutil
          import os

          packages = json.loads('${{ steps.pkg-config.outputs.packages }}')
          version = "${{ github.event.inputs.version }}"
          ros_distro = os.environ.get('ROS_DISTRO', 'humble')
          workspace = os.environ.get('GITHUB_WORKSPACE', '.')
          arch = subprocess.check_output(['dpkg', '--print-architecture']).decode().strip()

          # Collect all unique CPU targets across all packages
          all_targets = {}
          for pkg in packages:
              for target in pkg['arm64_targets']:
                  target_key = target['name']
                  if target_key not in all_targets:
                      all_targets[target_key] = target

          # Build once per CPU target, then package each package
          for target_name, target in all_targets.items():
              cpu_flags = target['cpu_flags']
              suffix = target['suffix']

              print(f"\n{'='*60}")
              print(f"Building for {target_name} with flags: {cpu_flags}")
              print(f"{'='*60}\n")

              # Clean previous build
              if os.path.exists('/ros2_ws/build'):
                  shutil.rmtree('/ros2_ws/build')
              if os.path.exists('/ros2_ws/install'):
                  shutil.rmtree('/ros2_ws/install')

              # Build with target-specific flags
              os.chdir('/ros2_ws')
              build_cmd = (
                  f'. /opt/ros/{ros_distro}/setup.sh && '
                  f'colcon build --cmake-args -DCMAKE_BUILD_TYPE=Release '
                  f'"-DCMAKE_CXX_FLAGS={cpu_flags}" '
                  f'"-DCMAKE_C_FLAGS={cpu_flags}"'
              )

              subprocess.run(build_cmd, shell=True, check=True, executable='/bin/bash')

              # Create .deb for each package that needs this target
              for pkg in packages:
                  pkg_targets = [t['name'] for t in pkg['arm64_targets']]
                  if target_name not in pkg_targets:
                      continue

                  deb_name = pkg['deb_name']
                  description = pkg['description']
                  dependencies = pkg['dependencies']
                  install_dirs = pkg['install_dirs']

                  print(f"\nPackaging {pkg['pkg_name']} for {target_name}...")

                  pkg_dir = '/deb_pkg'
                  install_dir = f'{pkg_dir}/opt/ros/{ros_distro}'

                  if os.path.exists(pkg_dir):
                      shutil.rmtree(pkg_dir)
                  os.makedirs(f'{pkg_dir}/DEBIAN')
                  os.makedirs(install_dir)

                  for dir_name in install_dirs:
                      src = f'/ros2_ws/install/{dir_name}'
                      if os.path.exists(src):
                          for item in os.listdir(src):
                              s = os.path.join(src, item)
                              d = os.path.join(install_dir, item)
                              if os.path.isdir(s):
                                  shutil.copytree(s, d, dirs_exist_ok=True)
                              else:
                                  shutil.copy2(s, d)
                          print(f"  Copied {dir_name}")

                  control_content = f"""Package: ros-{ros_distro}-{deb_name}{suffix}
          Version: {version}
          Section: misc
          Priority: optional
          Architecture: {arch}
          Depends: {dependencies}
          Maintainer: GitHub Actions <actions@github.com>
          Description: {description} (optimized for {target_name})
          """

                  with open(f'{pkg_dir}/DEBIAN/control', 'w') as f:
                      for line in control_content.strip().split('\n'):
                          f.write(line.strip() + '\n')

                  subprocess.run(['chmod', '-R', '755', pkg_dir], check=True)
                  subprocess.run(['chmod', '644', f'{pkg_dir}/DEBIAN/control'], check=True)

                  deb_file = f'ros-{ros_distro}-{deb_name}{suffix}_{version}_{arch}.deb'
                  subprocess.run(['dpkg-deb', '--build', pkg_dir, f'{workspace}/{deb_file}'], check=True)
                  print(f"  Created: {deb_file}")

          print("\nAll ARM64 packages built successfully!")
          PYEOF

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deb-${{ github.event.inputs.package }}-arm64
          path: ${{ github.workspace }}/*.deb

  build-amd64:
    runs-on: ubuntu-latest

    container:
      image: ros:humble-perception
      options: --user root

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          apt-get update
          apt-get install -y \
            python3-colcon-common-extensions \
            python3-rosdep \
            python3-pip \
            dpkg-dev \
            fakeroot \
            git
          pip3 install pyyaml

      - name: Get package config
        id: pkg-config
        run: |
          python3 << 'EOF'
          import yaml
          import json
          import os

          with open('.github/packages.yml', 'r') as f:
              config = yaml.safe_load(f)

          selected = '${{ github.event.inputs.package }}'

          if selected == 'all':
              package_names = list(config['packages'].keys())
          else:
              package_names = [selected]

          packages_info = []
          for pkg_name in package_names:
              pkg = config['packages'][pkg_name]
              packages_info.append({
                  'pkg_name': pkg_name,
                  'deb_name': pkg['deb_name'],
                  'description': pkg['description'].strip().split('\n')[0],
                  'repositories': pkg['repositories'],
                  'install_dirs': pkg['install_dirs'],
                  'dependencies': ', '.join(pkg['dependencies'])
              })

          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"packages={json.dumps(packages_info)}\n")

          print(f"Packages to build: {[p['pkg_name'] for p in packages_info]}")
          EOF

      - name: Initialize rosdep
        run: |
          rosdep init || true
          rosdep update

      - name: Clone repositories
        run: |
          mkdir -p /ros2_ws/src
          cd /ros2_ws/src

          python3 << 'EOF'
          import json
          import subprocess
          import os

          packages = json.loads('${{ steps.pkg-config.outputs.packages }}')
          cloned_repos = set()

          for pkg in packages:
              for repo in pkg['repositories']:
                  url = repo['url']
                  branch = repo['branch']
                  sparse = repo.get('sparse_checkout', None)
                  repo_name = url.rstrip('/').split('/')[-1].replace('.git', '')

                  repo_key = f"{url}:{branch}"
                  if repo_key in cloned_repos:
                      print(f"Skipping {repo_name} (already cloned)")
                      continue
                  cloned_repos.add(repo_key)

                  if sparse:
                      subprocess.run(['git', 'clone', '--filter=blob:none', '--sparse', '-b', branch, url, repo_name], check=True)
                      os.chdir(repo_name)
                      for path in sparse:
                          subprocess.run(['git', 'sparse-checkout', 'add', path], check=True)
                      os.chdir('..')
                  else:
                      subprocess.run(['git', 'clone', '-b', branch, url], check=True)
          EOF

      - name: Install package dependencies
        run: |
          cd /ros2_ws
          . /opt/ros/${ROS_DISTRO}/setup.sh
          rosdep install --from-paths src --ignore-src -r -y

      - name: Build packages
        run: |
          cd /ros2_ws
          . /opt/ros/${ROS_DISTRO}/setup.sh
          colcon build --cmake-args -DCMAKE_BUILD_TYPE=Release

      - name: Create .deb packages
        run: |
          python3 << 'PYEOF'
          import json
          import subprocess
          import shutil
          import os

          packages = json.loads('${{ steps.pkg-config.outputs.packages }}')
          version = "${{ github.event.inputs.version }}"
          ros_distro = os.environ.get('ROS_DISTRO', 'humble')
          workspace = os.environ.get('GITHUB_WORKSPACE', '.')
          arch = subprocess.check_output(['dpkg', '--print-architecture']).decode().strip()

          for pkg in packages:
              deb_name = pkg['deb_name']
              description = pkg['description']
              dependencies = pkg['dependencies']
              install_dirs = pkg['install_dirs']

              print(f"\nPackaging {pkg['pkg_name']}...")

              pkg_dir = '/deb_pkg'
              install_dir = f'{pkg_dir}/opt/ros/{ros_distro}'

              if os.path.exists(pkg_dir):
                  shutil.rmtree(pkg_dir)
              os.makedirs(f'{pkg_dir}/DEBIAN')
              os.makedirs(install_dir)

              for dir_name in install_dirs:
                  src = f'/ros2_ws/install/{dir_name}'
                  if os.path.exists(src):
                      for item in os.listdir(src):
                          s = os.path.join(src, item)
                          d = os.path.join(install_dir, item)
                          if os.path.isdir(s):
                              shutil.copytree(s, d, dirs_exist_ok=True)
                          else:
                              shutil.copy2(s, d)
                      print(f"  Copied {dir_name}")

              control_content = f"""Package: ros-{ros_distro}-{deb_name}
          Version: {version}
          Section: misc
          Priority: optional
          Architecture: {arch}
          Depends: {dependencies}
          Maintainer: GitHub Actions <actions@github.com>
          Description: {description}
          """

              with open(f'{pkg_dir}/DEBIAN/control', 'w') as f:
                  for line in control_content.strip().split('\n'):
                      f.write(line.strip() + '\n')

              subprocess.run(['chmod', '-R', '755', pkg_dir], check=True)
              subprocess.run(['chmod', '644', f'{pkg_dir}/DEBIAN/control'], check=True)

              deb_file = f'ros-{ros_distro}-{deb_name}_{version}_{arch}.deb'
              subprocess.run(['dpkg-deb', '--build', pkg_dir, f'{workspace}/{deb_file}'], check=True)
              print(f"  Created: {deb_file}")

          print("\nAll AMD64 packages built successfully!")
          PYEOF

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-${{ github.event.inputs.package }}-amd64
          path: ${{ github.workspace }}/*.deb

  release:
    needs: [build-arm64, build-amd64]
    runs-on: ubuntu-latest

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: debs
          pattern: deb-*
          merge-multiple: true

      - name: List artifacts
        run: ls -la debs/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.version }}-${{ github.event.inputs.package }}
          name: "ROS2 ${{ github.event.inputs.package }} v${{ github.event.inputs.version }}"
          files: debs/*.deb
          generate_release_notes: true
          body: |
            ## ROS2 Package Release

            **Package:** ${{ github.event.inputs.package }}
            **Version:** ${{ github.event.inputs.version }}
            **ROS Distro:** humble

            ### Available Builds
            - **amd64**: Generic x86_64 build
            - **arm64**: Multiple CPU-optimized builds (see filenames for target CPU)

            ### Installation
            ```bash
            # Download the appropriate .deb for your architecture/CPU
            sudo dpkg -i ros-humble-*.deb
            sudo apt-get install -f
            ```

            ### ARM64 CPU Variants
            - `*_arm64.deb` - Generic ARMv8-A
            - `*-a53_*_arm64.deb` - Optimized for Cortex-A53
            - `*-a72_*_arm64.deb` - Optimized for Cortex-A72
            - `*-a76_*_arm64.deb` - Optimized for Cortex-A76
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
